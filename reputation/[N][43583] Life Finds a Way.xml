<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<HBProfile>
    <Name>[Zakrn] Life Finds a Way</Name>
    <MinDurability>0.2</MinDurability>
    <MinFreeBagSlots>1</MinFreeBagSlots>
    <MinLevel>1</MinLevel>
    <MaxLevel>1000</MaxLevel>
    <MailGrey>false</MailGrey>
    <MailWhite>true</MailWhite>
    <MailGreen>true</MailGreen>
    <MailBlue>true</MailBlue>
    <MailPurple>true</MailPurple>
    <SellGrey>true</SellGrey>
    <SellWhite>false</SellWhite>
    <SellGreen>false</SellGreen>
    <SellBlue>false</SellBlue>
    <SellPurple>false</SellPurple>
    <TargetElites>true</TargetElites>
    <QuestOrder>
        <CustomBehavior File="RunCode" Type="Definition">
            <![CDATA[
                bool IsQuestAvailable( int questId ){
                    return  Lua.GetReturnVal<bool>("SetMapByID(1033); " +
                       " local taskInfo = C_TaskQuest.GetQuestsForPlayerByMapID(1033) " +
                       " if (taskInfo) then " +
                            "for i, info  in ipairs(taskInfo) do " +
                               " if info.questId ==   " + questId + " then " +
                                    "return true; " +
                                   " end " +
                           " end " +
                       " end " +
                        "return false;", 0);
                }
            ]]>
        </CustomBehavior>
        <CustomBehavior File="RunCode" Type="Definition">
            <![CDATA[

                    static double KILL_DIST = 30.0;

                    async Task VehicleMove(WoWPoint moveTo, bool allowCombat = true)
                    {
                        if (!StyxWoW.Me.InVehicle) return;
                        while (Me.Location.Distance(moveTo) >= 5)
                        {
                            WoWMovement.ClickToMove(moveTo);
                            if( allowCombat )
                            {
                                await CombatAwareness();
                            }
                            
                            await Coroutine.Yield();
                        }
                    }

                    async Task VehicleCombat(WoWUnit vehicleKill)
                    {
                        if (!StyxWoW.Me.InVehicle) return;
                        if (vehicleKill.Distance > KILL_DIST) return;
                        if (Me.CurrentTarget != vehicleKill)
                        {
                            vehicleKill.Target();
                        }
                        await Coroutine.Sleep(150);
                        Styx.Helpers.KeyboardManager.KeyUpDown((char)System.Windows.Forms.Keys.D1);
                        //Styx.Helpers.KeyboardManager.KeyUpDown((char)System.Windows.Forms.Keys.D2);
                        //Styx.Helpers.KeyboardManager.KeyUpDown((char)System.Windows.Forms.Keys.D3);
                        //Styx.Helpers.KeyboardManager.KeyUpDown((char)System.Windows.Forms.Keys.D4);
                        await Coroutine.Sleep(1050);
                    }

                    async Task CombatAwareness()
                    {
                        if (!StyxWoW.Me.InVehicle) return;
                        var killArray = ObjectManager.GetObjectsOfType<WoWUnit>().Where(u => u.IsTargetingMeOrPet && u.Distance <= KILL_DIST);
                        if (killArray == null) return;

                        foreach (WoWUnit killMe in killArray)
                        {
                            while (killMe != null && killMe.IsTargetingMeOrPet && killMe.Distance <= KILL_DIST)
                            {
                                await CommonCoroutines.StopMoving();
                                StyxWoW.Me.SetFacing(killMe.Location);
                                await VehicleCombat(killMe);
                                await Coroutine.Yield();
                            }
                       }
                    }
                ]]>
        </CustomBehavior>
        <If Condition="IsQuestAvailable(43583)">
            <If Condition="Me.SubZoneId != 8352">
                <MoveTo X="1502.694" Y="4012.854" Z="-13.92283" />
            </If>
            <If Condition="!Me.InVehicle">
                <CustomBehavior File="InteractWith" MobId="111062" X="1481.71" Y="4049.166" Z="-14.48639" TerminateWhen="Me.InVehicle" />
            </If>
            <DisableBehavior Name="Combat" />
            <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1516.029, 3961.502, 5.249563), false);" />
            <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1500.292, 3910.733, 19.28840), false);" />
            <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1498.144, 3869.376, 31.73428), false);" />
            <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1486.712, 3856.559, 30.98180), false);" />
            <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1485.412, 3825.464, 30.87040), false);" />
            <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1462.756, 3808.687, 30.95982), false);" />
            <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1371.434, 3766.487, 36.21667), false);" />
            <While Condition="IsQuestAvailable(43583)">
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1316.977 ,3699.123 ,16.73279));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1307.137 ,3628.186 ,35.45126));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1315.36 ,3575.188 ,35.45126));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1350.289 ,3552.876 ,35.45126));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1347.34 ,3525.178 ,35.45152));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1330.137 ,3509.279 ,35.45152));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1298.463 ,3515.715 ,35.45152));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1280.873 ,3545.425 ,35.45152));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1297.699 ,3570.633 ,35.45152));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1290.436 ,3618.851 ,35.45152));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1287.745 ,3674.432 ,26.96629));" TerminateWhen="IsQuestAvailable(43583)" />
                <CustomBehavior File="RunCode" Code="await VehicleMove(new WoWPoint(1302.36 ,3708.625 ,16.73022));" TerminateWhen="IsQuestAvailable(43583)" />
            </While>
            <EnableBehavior Name="Combat" />
        </If>
        <If Condition="Me.InVehicle">
            <CustomBehavior File="RunMacro" Macro="/click OverrideActionBarLeaveFrameLeaveButton" />
        </If>
        <If Condition="HasItem(141605) &amp;&amp; Me.BagItems.FirstOrDefault(h =&gt; h.Entry == 141605).CooldownTimeLeft.TotalMilliseconds == 0">
            <CustomBehavior File="UseItem" ItemId="141605" WaitTime="2000" />
        </If>
        <CustomBehavior File="LoadProfile" ProfileName="./[N] Daily Loader" RememberProfile="false" />
    </QuestOrder>
</HBProfile>
